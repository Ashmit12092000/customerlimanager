{% extends "base.html" %}

{% block title %}{{ customer.name }} - Customer Profile{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-user me-2"></i>{{ customer.name }}</h1>
    <div>
        <a href="{{ url_for('export_customer_report', customer_id=customer.id) }}" class="btn btn-success me-2">
            <i class="fas fa-file-excel me-1"></i>Export to Excel
        </a>
        {% if current_user.role in ['data_entry', 'admin'] %}
        <a href="{{ url_for('transactions', customer_id=customer.id) }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>Add Transaction
        </a>
        {% endif %}
    </div>
</div>

<!-- Customer Information -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle me-2"></i>Customer Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="40%">ICL No:</th>
                        <td>{{ customer.icl_no }}</td>
                    </tr>
                    <tr>
                        <th>Name:</th>
                        <td>{{ customer.name }}</td>
                    </tr>
                    <tr>
                        <th>Address:</th>
                        <td>{{ customer.address or 'Not specified' }}</td>
                    </tr>
                    <tr>
                        <th>Contact:</th>
                        <td>{{ customer.contact_details or 'Not specified' }}</td>
                    </tr>
                    <tr>
                        <th>Annual Rate:</th>
                        <td>{{ customer.annual_rate }}%</td>
                    </tr>
                    <tr>
                        <th>Interest Type:</th>
                        <td>
                            <span class="badge bg-{{ 'success' if customer.interest_type == 'simple' else 'warning' }}">
                                {{ customer.interest_type.title() }}
                            </span>
                        </td>
                    </tr>
                    {% if customer.interest_type == 'compound' %}
                    <tr>
                        <th>Compound Frequency:</th>
                        <td>{{ customer.compound_frequency.title() if customer.compound_frequency else 'Not specified' }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>TDS Applicable:</th>
                        <td>
                            <span class="badge bg-{{ 'success' if customer.tds_applicable else 'secondary' }}">
                                {{ 'Yes' if customer.tds_applicable else 'No' }}
                            </span>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar me-2"></i>Timeline & Balance</h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless">
                    <tr>
                        <th width="40%">Start Date:</th>
                        <td>{{ customer.icl_start_date.strftime('%d-%m-%Y') if customer.icl_start_date else 'N/A' }}</td>
                    </tr>
                    <tr>
                        <th>End Date:</th>
                        <td>{{ customer.icl_end_date.strftime('%d-%m-%Y') if customer.icl_end_date else 'Not specified' }}</td>
                    </tr>
                    <tr>
                        <th>Extension:</th>
                        <td>{{ customer.icl_extension or 'None' }}</td>
                    </tr>
                    {% if customer.first_compounding_date %}
                    <tr>
                        <th>First Compounding:</th>
                        <td>{{ customer.first_compounding_date.strftime('%d-%m-%Y') }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Current Balance:</th>
                        <td>
                            <h4 class="text-{{ 'success' if current_balance >= 0 else 'danger' }}">
                                ₹{{ "{:,.2f}".format(current_balance) }}
                            </h4>
                        </td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Transaction History -->
<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-history me-2"></i>Transaction History</h5>
    </div>
    <div class="card-body">
        {% if transactions %}
        <div class="table-responsive">
            <table class="table table-striped" id="transactionsTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount Paid</th>
                        <th>Amount Repaid</th>
                        <th>Balance</th>
                        <th>Period From</th>
                        <th>Period To</th>
                        <th>Days</th>
                        <th>Int Rate</th>
                        <th>Int Amount</th>
                        <th>TDS</th>
                        <th>Net Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr>
                        <td>{{ transaction.date.strftime('%d-%m-%Y') }}</td>
                        <td>
                            {% if transaction.amount_paid %}
                                <span class="text-success">₹{{ "{:,.2f}".format(transaction.amount_paid) }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if transaction.amount_repaid %}
                                <span class="text-danger">₹{{ "{:,.2f}".format(transaction.amount_repaid) }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>₹{{ "{:,.2f}".format(transaction.balance) if transaction.balance else '-' }}</td>
                        <td>{{ transaction.period_from.strftime('%d-%m-%Y') if transaction.period_from else '-' }}</td>
                        <td>{{ transaction.period_to.strftime('%d-%m-%Y') if transaction.period_to else '-' }}</td>
                        <td>{{ transaction.no_of_days if transaction.no_of_days else '-' }}</td>
                        <td>{{ transaction.int_rate }}% if transaction.int_rate else '-' }}</td>
                        <td>₹{{ "{:,.2f}".format(transaction.int_amount) if transaction.int_amount else '-' }}</td>
                        <td>₹{{ "{:,.2f}".format(transaction.tds_amount) if transaction.tds_amount else '-' }}</td>
                        <td>₹{{ "{:,.2f}".format(transaction.net_amount) if transaction.net_amount else '-' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="table-secondary">
                        <th>Total</th>
                        <th>₹{{ "{:,.2f}".format(transactions|sum(attribute='amount_paid')|default(0)) }}</th>
                        <th>₹{{ "{:,.2f}".format(transactions|sum(attribute='amount_repaid')|default(0)) }}</th>
                        <th>-</th>
                        <th>-</th>
                        <th>-</th>
                        <th>{{ transactions|sum(attribute='no_of_days')|default(0) }}</th>
                        <th>-</th>
                        <th>₹{{ "{:,.2f}".format(transactions|sum(attribute='int_amount')|default(0)) }}</th>
                        <th>₹{{ "{:,.2f}".format(transactions|sum(attribute='tds_amount')|default(0)) }}</th>
                        <th>₹{{ "{:,.2f}".format(transactions|sum(attribute='net_amount')|default(0)) }}</th>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="text-center py-4">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <p class="text-muted">No transactions found for this customer.</p>
            {% if current_user.role in ['data_entry', 'admin'] %}
            <a href="{{ url_for('transactions', customer_id=customer.id) }}" class="btn btn-primary">
                <i class="fas fa-plus me-1"></i>Add First Transaction
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    if (!$.fn.DataTable.isDataTable('#transactionsTable')) {
        $('#transactionsTable').DataTable({
            responsive: true,
            pageLength: 25,
            order: [[0, 'desc']], // Sort by date descending
            footerCallback: function(row, data, start, end, display) {
                // This callback is called every time the table is drawn
                // You can add custom footer calculations here if needed
            }
        });
    }
});
</script>
{% endblock %}
